---
title: 网路安全之HSTS
date: 2021-03-04 10:31:55
tags:
  - HTML5
category: 游览器协议
---

很多人知道 301、302 状态码，但是几乎没有了解过 303、307 的状态码，有幸今天在淘宝首页看见了 307 状态，所以便想了解其使用。

## 中间人劫持（302 使用）

当我们在游览器中输入 URL 的时候，游览器默认请求端口是 80，但 https 请求是通过 443 端口进行数据传输的，那怎么办呢，这时我们就要在游览器和服务器之间进行一个中间人劫持的行为，首先中间人会劫持（或者直接占用）80 端口，当游览器有请求过来时会模拟正常的 https 向服务器进行请求数据，然后在通过 80 端口返回给用户。
<label style="background-color: #fff5f5;color:#ff502c;">http 请求（320 重定向）</label>
![](/images/middle/middle02.png)
<label style="background-color: #fff5f5;color:#ff502c;">中间人劫持</label>
![](/images/middle/middle01.png)
只要能够劫持你的网络，比如路由劫持、DNS 劫持，就可以作为中间人注入代码、替换广告。
这种劫持出现在两种情况下：

- 用户没有通过准确的方式访问页面，除非输入 // ，否则浏览器默认以 http 方式访问。
- HTTPS 页面的链接中包含 http，这个 http 页面可能被劫持

## 启用 HSTS

HSTS，HTTP Strict Transport Security，简单说就是强制客户端使用 HTTPS 访问页面。其原理就是：

- 在服务器响应头中添加 Strict-Transport-Security，可以设置 max-age
- 用户访问时，服务器种下这个头
- 下次如果使用 http 访问，只要 max-age 未过期，客户端会进行内部跳转，可以看到 307 Redirect Internel 的响应码
- 变成 https 访问源服务器

启用 HSTS 不仅仅可以有效防范中间人攻击，同时也为浏览器节省来一次 302/301 的跳转请求，收益还是很高的。其实就是通过 head 头的设置将 http 请求强制转换为 https 请求。

## 307 状态码

在 GET、HEAD 这些幂等的请求方式上，302、303、307 没啥区别，而对于 POST 就不同了，大部分浏览器 都会 302 会将 POST 请求转为 GET，而 303 是规范强制规定将 POST 转为 GET 请求，请求地址为 header 头中的 Location，307 则不一样，规范要求浏览器继续向 Location 的地址 POST 内容。

而在 HSTS 中，307 可以被缓存，缓存时间根据 max-age 而定，一般建议缓存 1 年甚至更长。

## HSTS 存在的坑

- 纯 IP 的请求，HSTS 没法处理，比如 http://2.2.2.2 ， 即便响应头中设置了 STS，浏览器也不会理会（未测试）
- HSTS 只能在 80 和 443 端口之间切换，如果服务是 8080 端口，即便设置了 STS，也无效（未测试）
- 如果浏览器证书错误，一般情况会提醒存在安全风险，然是依然给一个链接进入目标页，而 HSTS 则没有目标页入口，所以一旦证书配置错误，就是很大的故障了
- 如果服务器的 HTTPS 没有配置好就开启了 STS 的响应头，并且还设置了很长的过期时间，那么在你服务器 HTTPS 配置好之前，用户都是没办法连接到你的服务器的，除非 max-age 过期了。
